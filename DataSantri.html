<script>
    async function muatDataSantri() {
        const overlay = document.getElementById('loadingOverlay');
        const icon = document.getElementById('iconRefresh');
        const kat = document.getElementById('sortKategori').value;
        const thnFilter = document.getElementById('sortTahun').value;
        const footer = document.getElementById('tabelSantriFooter');
        
        // Ambil ID dari CONFIG
        const targetID = (kat === 'PUSAT') ? CONFIG.DB.SANTRI_PUSAT : CONFIG.DB.SANTRI_CABANG;

        overlay.classList.remove('hidden');
        icon.classList.add('fa-spin');
        footer.classList.add('hidden'); 

        try {
            const response = await fetch(`${CONFIG.SCRIPT_URL}?action=bacaSantri&targetID=${targetID}`);
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();

            let html = '';
            let tL = 0, tP = 0, tTotal = 0;

            // PERBAIKAN: Gunakan huruf KAPITAL sesuai output JSON Backend
            const filteredData = data.filter(row => thnFilter === 'all' || row['TAHUN'] === thnFilter);

            if (filteredData.length > 0) {
                filteredData.forEach(row => {
                    // PERBAIKAN: Ambil data menggunakan kunci KAPITAL
                    const valL = parseInt(row['LAKI-LAKI']) || 0;
                    const valP = parseInt(row['PEREMPUAN']) || 0;
                    const totalRow = parseInt(row['TOTAL']) || (valL + valP);
                    const labelLembaga = row['TINGKATAN'] || row['NAMA PENGURUS CABANG'] || "-";
                    
                    tL += valL;
                    tP += valP;
                    tTotal += totalRow;

                    html += `
                        <tr class="border-b border-gray-50 hover:bg-green-50/30 transition-colors duration-200">
                            <td class="px-8 py-5 text-gray-400 font-medium">${row['TAHUN']}</td>
                            <td class="px-6 py-5">
                                <span class="flex items-center gap-3">
                                    <span class="w-2.5 h-2.5 rounded-full shadow-sm ${kat === 'PUSAT' ? 'bg-blue-500' : 'bg-green-500'}"></span>
                                    <span class="text-gray-700">${labelLembaga}</span>
                                </span>
                            </td>
                            <td class="px-6 py-5 text-center font-mono">${valL.toLocaleString()}</td>
                            <td class="px-6 py-5 text-center font-mono">${valP.toLocaleString()}</td>
                            <td class="px-8 py-5 text-center">
                                <span class="bg-gray-100 px-4 py-1.5 rounded-full text-gray-800 font-black text-[10px]">${totalRow.toLocaleString()}</span>
                            </td>
                        </tr>
                    `;
                });

                document.getElementById('tabelSantriBody').innerHTML = html;
                
                document.getElementById('totalL').innerText = tL.toLocaleString();
                document.getElementById('totalP').innerText = tP.toLocaleString();
                document.getElementById('totalSemua').innerText = tTotal.toLocaleString() + " SANTRI";
                footer.classList.remove('hidden');
            } else {
                document.getElementById('tabelSantriBody').innerHTML = '<tr><td colspan="5" class="py-20 text-center text-gray-400 uppercase tracking-widest text-[10px] font-black">Data Tidak Ditemukan</td></tr>';
            }

        } catch (e) {
            console.error("Fetch Error:", e);
            // Tips: Jika alert mengganggu, bisa diganti dengan notifikasi toast
            document.getElementById('tabelSantriBody').innerHTML = '<tr><td colspan="5" class="py-20 text-center text-red-400 italic">Terjadi kesalahan saat memuat data. Periksa koneksi atau URL Script.</td></tr>';
        } finally {
            overlay.classList.add('hidden');
            icon.classList.remove('fa-spin');
        }
    }

    muatDataSantri();
</script>
